name: Generate and Upload YouTube Short

on:
  schedule:
    # Runs daily at 12:05 UTC (adjust to your timezone). Change as needed.
    - cron: '5 12 * * *'
  workflow_dispatch: {}

jobs:
  generate-and-upload:
    name: Generate and upload a YouTube short
    runs-on: ubuntu-latest
    env:
      # Optional: override defaults here, or set repository secrets
      VIDEO_ASSEMBLY_TIMEOUT_SEC: '600'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install system dependencies (ffmpeg)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Show environment (debug)
        run: |
          echo "Running on $(uname -a)"
          python -V

      - name: Run one-off generation (scripts/run_generate.py)
        env:
          # Map required secrets to env variables used by the app
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GROQ_API_URL: ${{ secrets.GROQ_API_URL }}
          TARGET_TOPIC: ${{ secrets.TARGET_TOPIC || 'python' }}
          VIDEO_ASSEMBLY_TIMEOUT_SEC: ${{ secrets.VIDEO_ASSEMBLY_TIMEOUT_SEC || '600' }}
          STARTUP_VERIFICATION: 'false'
          # Add any other secrets you use (TTS keys, etc.)
        run: |
          # Ensure we run a single non-daemon generation job
          python scripts/run_generate.py

      - name: Upload workflow run artifact (logs)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-logs
          path: |
            output/shorts/**
            *.log
