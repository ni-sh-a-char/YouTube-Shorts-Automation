name: Generate and Upload YouTube Short

on:
  schedule:
    # Runs daily at 12:05 UTC (adjust to your timezone). Change as needed.
    - cron: '5 12 * * *'
  workflow_dispatch: {}

jobs:
  generate-and-upload:
    name: Generate and upload a YouTube short
    runs-on: ubuntu-latest
    env:
      # Optional: override defaults here, or set repository secrets
      VIDEO_ASSEMBLY_TIMEOUT_SEC: '600'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install system dependencies (ffmpeg)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python requirements
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt

      - name: Show environment (debug)
        run: |
          echo "Running on $(uname -a)"
          python -V

      - name: Run one-off generation (scripts/run_generate.py)
        env:
          # === REQUIRED SECRETS ===
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          # GROQ_API_URL: ${{ secrets.GROQ_API_URL }}
          GROQ_MODEL: openai/gpt-oss-120b
          
          # === OPTIONAL: API Keys ===
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY || '' }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY || '' }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY || '' }}
          TTSMAKER_API_KEY: ${{ secrets.TTSMAKER_API_KEY || '' }}
          
          # === CONTENT SETTINGS ===
          TARGET_TOPIC: ${{ secrets.TARGET_TOPIC || 'Python' }}
          TOPICS_ROTATION: ${{ secrets.TOPICS_ROTATION || 'Python,VS Code,Git,Docker,Linux' }}
          CONTENT_NICHE: tech/coding
          
          # === VIDEO SETTINGS ===
          VIDEO_RESOLUTION: 1080x1920
          VIDEO_FPS: 24
          TARGET_VIDEO_DURATION: 30
          OUTPUT_FORMAT: short
          
          # === LLM SETTINGS ===
          LLM_PROVIDER: groq
          
          # === CAPTION SETTINGS ===
          CAPTIONS_ENABLED: 'true'
          CAPTIONS_FORMAT: srt
          CAPTIONS_EMBED_ON_VIDEO: 'true'
          CAPTIONS_FONT_SIZE: '40'
          CAPTIONS_FONT_COLOR: '#FFFFFF'
          CAPTIONS_BG_COLOR: '#000000'
          CAPTIONS_BG_ALPHA: '0.5'
          
          # === TTS SETTINGS ===
          TTS_PROVIDER: gtts
          TTS_LANGUAGE: en
          TTS_SPEED: normal
          
          # === YOUTUBE SETTINGS ===
          YOUTUBE_PRIVACY_STATUS: public
          YOUTUBE_CATEGORY_ID: '28'
          AUTO_TAG_SHORTS: 'true'
          
          # === DIRECTORY/LOGGING SETTINGS ===
          OUTPUT_DIR: output
          TEMP_DIR: ./output/temp
          LOG_DIR: output/logs
          STOCK_FOOTAGE_DIR: ./output/stock_footage
          LOG_LEVEL: INFO
          LOG_TO_FILE: 'true'
          LOG_FILE_MAX_SIZE_MB: '10'
          LOG_BACKUP_COUNT: '5'
          
          # === MISC SETTINGS ===
          STARTUP_VERIFICATION: 'true'
          DRY_RUN: 'false'
          CLEANUP_TEMP: 'true'
          VERBOSE: 'false'
          KEEP_INTERMEDIATE_FILES: 'false'
          VIDEO_ASSEMBLY_TIMEOUT_SEC: '600'
        run: |
          # Ensure we run a single non-daemon generation job
          python scripts/run_generate.py

      - name: Upload workflow run artifact (logs)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-logs
          path: |
            output/shorts/**
            *.log
